<form novalidate name="addBuyingRateChargeFormOps" #addBuyingRateChargeFormOps="ngForm"
  (ngSubmit)="addBuyingRateChargeFormOps.form.valid">
  <div class="modal fade" id="ops-add-buying-rate-modal" bsModal #popup="bs-modal" role="dialog"
    (onHide)="onHide($event)" (onShow)="onShow($event)">

    <div class="modal-dialog c-modal-fullscreen" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add buying charge</h5>
          <button type="button" class="close" aria-label="Close" (click)="close(addBuyingRateChargeFormOps)">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body" *ngIf="isDisplay">
          <div class="m-form m-form--state">
            <div class="row">
              <div class="col-lg-4">
                <div class="form-group"
                  [ngClass]="{ 'm-form__group has-danger': addBuyingRateChargeFormOps.submitted && buyingRateChargeToAdd.chargeId==null}">
                  <label class="form-control-label" for="" #selectedBuyingChargeCode>
                    Charge <span class="m--font-danger">(*)</span>
                    <small class="m--margin-left-5 m--font-primary"> &nbsp;
                      {{selectedBuyingChargeCode.value==null?'':selectedBuyingChargeCode.value}}
                    </small>
                  </label>
                  <app-combo-grid-virtual-scroll
                    [currentActiveItemId]="{field:'charge.id',value:buyingRateChargeToAdd.chargeId}" (itemSelected)="buyingRateChargeToAdd.chargeId=$event.charge.id;
                                            buyingRateChargeToAdd.unitId=$event.charge.unitId;
                                            buyingRateChargeToAdd.unitPrice=$event.charge.unitPrice;
                                            buyingRateChargeToAdd.vatrate=$event.charge.vatrate;
                                            selectedBuyingChargeCode.value=$event.charge.code;
                                            buyingRateChargeToAdd.currencyId = $event.currency;
                                            currentActiveItemDefault=[{ id: $event.currency, text: $event.currency }];
                                            buyingRateChargeToAdd.currencyId=$event.currency;
                                            calculateTotalEachBuying();"
                    [selectedDisplayFields]="['charge.chargeNameEn']" [dataSources]="lstBuyingRateChargesComboBox"
                    [displayFields]="[{'field':'charge.code','label':'Charge Code'},{'field':'charge.chargeNameEn','label':'Name EN'},{'field':'charge.chargeNameVn','label':'Name VN'}]">
                  </app-combo-grid-virtual-scroll>
                  <div class="form-control-feedback"
                    *ngIf="addBuyingRateChargeFormOps.submitted && buyingRateChargeToAdd.chargeId==null">
                    Charge is required
                  </div>
                </div>
              </div>


              <div class="col-lg-4">
                <div class="form-group"
                  [ngClass]="{ 'm-form__group has-danger': addBuyingRateChargeFormOps.submitted && buyingRateChargeToAdd.objectBePaid==null }">
                  <label class="form-control-label" for="">
                    Partner type <span class="m--font-danger">(*)</span>
                  </label>
                  <ng-select [allowClear]="true" [items]="[
                                                { 'text': 'AGENT', 'id': 'AGENT' },
                                                { 'text': 'SHIPPING LINE','id': 'SHIPPING' },
                                                { 'text': 'OTHER', 'id': 'OTHER' }]"
                    (selected)="buyingRateChargeToAdd.objectBePaid=$event.id;
                                                    buyingRateChargeToAdd.objectBePaid==='AGENT'? buyingRateChargeToAdd.paymentObjectId=opsTransaction.agentId:null;
                                                    buyingRateChargeToAdd.objectBePaid==='SHIPPING'? buyingRateChargeToAdd.paymentObjectId=opsTransaction.supplierId:null;
                                                    buyingRateChargeToAdd.objectBePaid==='OTHER'? buyingRateChargeToAdd.paymentObjectId=null:null;"
                    (removed)="buyingRateChargeToAdd.objectBePaid=null;buyingRateChargeToAdd.paymentObjectId=null;"
                   placeholder="Select filter">
                  </ng-select>

                  <div class="form-control-feedback"
                    *ngIf="addBuyingRateChargeFormOps.submitted && buyingRateChargeToAdd.objectBePaid==null">
                    Partner type is required !
                  </div>
                </div>
              </div>


              <div class="col-lg-4">
                <div class="form-group"
                  [ngClass]="{ 'm-form__group has-danger': (addBuyingRateChargeFormOps.submitted && buyingRateChargeToAdd.paymentObjectId==null)||(!addBuyingRateChargeFormOps.submitted && buyingRateChargeToAdd.objectBePaid!==null && buyingRateChargeToAdd.objectBePaid!=='OTHER' && buyingRateChargeToAdd.paymentObjectId ===null)}">
                  <label class="form-control-label" for="">
                    Partner name <span class="m--font-danger">(*)</span>
                  </label>
                  <app-combo-grid-virtual-scroll [disabled]="buyingRateChargeToAdd.objectBePaid!=='OTHER'"
                    [currentActiveItemId]="{field:'id',value:buyingRateChargeToAdd.paymentObjectId}"
                    (itemSelected)="buyingRateChargeToAdd.paymentObjectId = $event.id"
                    (remove)="buyingRateChargeToAdd.paymentObjectId=null" [selectedDisplayFields]="['shortName']"
                    [dataSources]="lstPartners"
                    [displayFields]="[{'field':'id','label':'Partner ID'},{'field':'shortName','label':'Name ABBR'},{'field':'partnerNameEn','label':'Name EN'},{'field':'taxCode','label':'Tax Code'}]">
                  </app-combo-grid-virtual-scroll>

                  <div class="form-control-feedback"
                    *ngIf="addBuyingRateChargeFormOps.submitted && buyingRateChargeToAdd.paymentObjectId==null">
                    Partner name is required !
                  </div>

                  <div class="form-control-feedback"
                    *ngIf="(!addBuyingRateChargeFormOps.submitted && buyingRateChargeToAdd.objectBePaid!==null && buyingRateChargeToAdd.objectBePaid!=='OTHER' && buyingRateChargeToAdd.paymentObjectId ===null)">
                    Partner does not exist !
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-4">
                <div class="form-group"
                  [ngClass]="{ 'm-form__group has-danger': addBuyingRateChargeFormOps.submitted && (buyingRateChangeQuantityNameOps.invalid || buyingRateChargeToAdd.quantity ==0)}">
                  <label class="form-control-label" for="">
                    Quantity <span class="m--font-danger">(*)</span>
                  </label>
                  <div class="input-group m-input-group m-input-group--square">
                    <input type="number" required class="form-control m-input m-input--square" min="0"
                      placeholder="Enter number" name="buyingRateChangeQuantityNameOps" decimalNumberGreaterThan0
                      #buyingRateChangeQuantityNameOps="ngModel" [(ngModel)]="buyingRateChargeToAdd.quantity"
                      (change)="calculateTotalEachBuying()" (keyup)="calculateTotalEachBuying()">
                  </div>
                  <div class="form-control-feedback"
                    *ngIf="addBuyingRateChargeFormOps.submitted && buyingRateChangeQuantityNameOps.invalid">
                    Quantity is required !
                  </div>
                  <div class="form-control-feedback"
                    *ngIf="addBuyingRateChargeFormOps.submitted && buyingRateChargeToAdd.quantity ==0">
                    Quantity must be greater than 0 !
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="form-group"
                  [ngClass]="{ 'm-form__group has-danger': addBuyingRateChargeFormOps.submitted && buyingRateChargeToAdd.unitId==null}">
                  <label class="form-control-label" for="">
                    Unit <span class="m--font-danger">(*)</span>
                  </label>

                  <app-combo-grid-virtual-scroll [currentActiveItemId]="{field:'id',value:buyingRateChargeToAdd.unitId}"
                    (itemSelected)="buyingRateChargeToAdd.unitId=$event.id" [selectedDisplayFields]="['unitNameEn']"
                    [dataSources]="lstUnits"
                    [displayFields]="[{'field':'unitNameEn','label':'Name EN'},{'field':'unitType','label':'Unit type'}]">
                  </app-combo-grid-virtual-scroll>


                  <div class="form-control-feedback"
                    *ngIf="addBuyingRateChargeFormOps.submitted && buyingRateChargeToAdd.unitId==null">
                    Unit is required
                  </div>


                </div>
              </div>
              <div class="col-lg-4">
                <div class="form-group"
                  [ngClass]="{ 'm-form__group has-danger': addBuyingRateChargeFormOps.submitted &&(BuyingRateChargeUnitPriceNameOps.invalid || (0 >= buyingRateChargeToAdd.unitPrice)) }">
                  <label class="form-control-label" for="">
                    Unit price <span class="m--font-danger">(*)</span>
                  </label>
                  <input type="number" class="form-control m-input m-input--square" autocomplete="nope"
                    [(ngModel)]="buyingRateChargeToAdd.unitPrice" (change)="calculateTotalEachBuying()"
                    (keyup)="calculateTotalEachBuying()" placeholder="Enter number"
                    #BuyingRateChargeUnitPriceNameOps="ngModel" required name="BuyingRateChargeUnitPriceNameOps">
                  <div class="form-control-feedback"
                    *ngIf="addBuyingRateChargeFormOps.submitted &&(BuyingRateChargeUnitPriceNameOps.invalid || (0 >= buyingRateChargeToAdd.unitPrice))">
                    Unit Price is required and must be larger than 0 !
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-4">
                <div class="form-group"
                  [ngClass]="{ 'm-form__group has-danger': addBuyingRateChargeFormOps.submitted && buyingRateChargeToAdd.currencyId===null }">
                  <label class="form-control-label" for="">
                    Currency <span class="m--font-danger">(*)</span>
                  </label>

                  <ng-select [allowClear]="true" [items]="lstCurrencies"
                    [active]="currentActiveItemDefault" (selected)="buyingRateChargeToAdd.currencyId=$event.id"
                    (removed)="buyingRateChargeToAdd.currencyId=null" placeholder="Select filter">
                  </ng-select>

                  <div class="form-control-feedback"
                    *ngIf="addBuyingRateChargeFormOps.submitted && buyingRateChargeToAdd.currencyId===null">
                    Currency is required
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="form-group"
                  [ngClass]="{ 'm-form__group has-danger': addBuyingRateChargeFormOps.submitted && (BuyingRateChargeVATNameOps.invalid || buyingRateChargeToAdd.vatrate >100) }">
                  <label class="form-control-label" for="">
                    VAT <span class="m--font-danger">(*)</span>
                  </label>
                  <input type="number" name="BuyingRateChargeVATNameOps" required #BuyingRateChargeVATNameOps="ngModel"
                    [(ngModel)]="buyingRateChargeToAdd.vatrate" class="form-control m-input m-input--square"
                    placeholder="Enter number" (change)="calculateTotalEachBuying()"
                    (keyup)="calculateTotalEachBuying()">
                  <div class="form-control-feedback"
                    *ngIf="addBuyingRateChargeFormOps.submitted && (BuyingRateChargeVATNameOps.invalid || buyingRateChargeToAdd.vatrate >100)">
                    VAT is required and must be less than or equal 100
                  </div>
                </div>
              </div>
              <div class="col-lg-4">
                <div class="form-group">
                  <label class="form-control-label" for="">
                    Total
                  </label>
                  <input type="text" class="form-control m-input m-input--square" disabled
                    name="BuyingRateChargeTotalNameOps" [(ngModel)]="buyingRateChargeToAdd.total">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-4">
                <div class="form-group">
                  <label class="form-control-label" for="">
                    Doc no
                  </label>
                  <input type="text" [(ngModel)]="buyingRateChargeToAdd.docNo" autocomplete="nope"
                    class="form-control m-input m-input--square" placeholder="Enter text"
                    name="BuyingRateChargeDocNameOps">
                </div>
              </div>
              <div class="col-lg-4">
                <div class="form-group">
                  <label class="form-control-label" for="">
                    Note
                  </label>
                  <input type="text" [(ngModel)]="buyingRateChargeToAdd.notes" autocomplete="nope"
                    class="form-control m-input m-input--square" placeholder="Enter text"
                    name="BuyingRateChargeNoteNameOps">
                </div>
              </div>
              <div class="col-lg-4">
                <div class="form-group">
                  <label class="form-control-label" for="">
                    &nbsp;
                  </label>
                  <div>
                    <label class="m-checkbox m-checkbox--bold">
                      <input type="checkbox" name="BuyingRateChargeKickBackNameOps"
                        [(ngModel)]="buyingRateChargeToAdd.kickBack">
                      Kick back
                      <span></span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-4">
                <div class="form-group">
                  <label for="">Invoice No</label>
                  <input type="text" class="form-control" [(ngModel)]="buyingRateChargeToAdd.invoiceNo" name="invoiceNo">
                </div>
              </div>
              <div class="col-lg-4">
                <div class="form-group">
                  <label for="">Invoice Date</label>
                  <div class="m-input-icon m-input-icon--right down">
                    <input type="text" class="form-control m-input m-input--square" ngxDaterangepickerMd [autoApply]="true"
                      [locale]="{applyLabel: 'ok', format: 'DD/MM/YYYY'}" [(ngModel)]="invoiceDate" [singleDatePicker]="true"
                      name="invoiceDate" readonly />
                    <span class="m-input-icon__icon m-input-icon__icon--right">
                      <span>
                        <i class="la la-calendar"></i>
                      </span>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer m--align-center">
          <button class="btn btn-success m-btn--square m-btn--icon m-btn--uppercase" type=""
            (click)="buyingRateChargeToAdd.type='BUY';saveNewCharge('ops-add-buying-rate-modal',addBuyingRateChargeFormOps,true)">
            <span>
              <i class="la la-plus"></i>
              <span>
                save & continue
              </span>
            </span>
          </button>
          <button class="btn btn-brand m-btn--square m-btn--icon m-btn--uppercase" type=""
            (click)="buyingRateChargeToAdd.type='BUY';saveNewCharge('ops-add-buying-rate-modal',addBuyingRateChargeFormOps,false)">
            <span>
              <i class="la la-save"></i>
              <span>
                save
              </span>
            </span>
          </button>
          <button type="button" class="btn btn-cancel m-btn--square m-btn--icon m-btn--uppercase"
            (click)="close(addBuyingRateChargeFormOps)">
            <span>
              <i class="la la-ban"></i>
              <span>
                cancel
              </span>
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>
</form>